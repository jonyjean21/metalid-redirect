# METALID システム 要件定義書

**バージョン**: 1.0
**作成日**: 2026-02-18
**対象**: モルックコミュニティ向けメタルIDカードシステム

---

## 1. プロジェクト概要

### 1.1 背景・目的

モルッカー（モルックプレイヤー）が**メタルカードを集めたくなる**仕組みを作る。
メタルカードはコレクション性を持ち、コミュニティの繋がりを深めるツールとなる。

- カードを持つこと自体がステータスになる
- 他のモルッカーのカードを集めることで仲間の輪が広がる
- QRコードからその人の活動・実績が見えることで、初対面でも話題ができる

### 1.2 システム全体像

```
[メタルカード配布]
       ↓
 カードにQRコード
       ↓
  スキャンすると
       ↓
┌─────────────────────────────────────┐
│        個人ハブページ                │
│  （リットリンクのようなもの）         │
│  ・モルックネーム                    │
│  ・所属チーム                        │
│  ・自己紹介                          │
│  ・SNSリンク（X/Instagram等）        │
│  ・専用プロフィールページへのリンク  │
└─────────────────────────────────────┘
                ↓
      専用プロフィールページ
  ・詳細な個人情報（公開設定あり）
  ・戦績・出場大会
  ・取得バッジ・実績
```

### 1.3 カード配布フロー

```
[管理者]
  ↓ 会員番号を発行
  ↓ メタルカード（QR付き）を作成
  ↓ 紙のQR（登録用URL）も印刷
  ↓
[会員]
  紙のQRをスキャン → 会員登録ページ
  会員番号を入力して登録
  プロフィールをカスタマイズ
  ↓
  メタルカードのQRが自分のページに紐付けられる
```

---

## 2. ユーザー種別と権限

### 2.1 ユーザー種別

| 種別 | 説明 | 主な操作 |
|------|------|----------|
| **ビジター** | ログイン不要の閲覧者 | プロフィールページの閲覧、QRスキャン |
| **会員** | メタルカード保有者 | プロフィール編集、コレクション管理 |
| **管理者** | システム運営者 | 会員管理、カード発行、大会管理 |

---

## 3. 機能要件（フェーズ別）

### Phase 1 — MVP（最初にリリースするもの）

#### 3.1.1 会員登録・認証

| 機能 | 詳細 |
|------|------|
| 会員登録 | 招待トークン付きURLからのみ登録可能（オープン登録なし） |
| ログイン | メールアドレス＋パスワード |
| パスワードリセット | メール経由 |
| 招待トークン | 管理者が発行。30日で失効。1トークン1アカウントのみ |

**登録フロー詳細：**
1. 管理者がダッシュボードから会員を作成（会員番号を割り当て）
2. システムが登録用URL（トークン付き）を生成
3. 管理者が登録用URLのQRコードを**紙**に印刷して渡す
4. 会員が紙のQRをスキャン → 登録フォームへ
5. 会員がメールアドレスとパスワードを設定
6. メール認証後、プロフィール設定ページへ
7. メタルカードのQRが会員のページに紐付けられる

#### 3.1.2 個人ハブページ（リットリンク型）

URL: `metalid.jp/u/{会員番号}`

| 項目 | 必須 | 説明 |
|------|------|------|
| モルックネーム | ○ | 表示名（ニックネーム） |
| アイコン画像 | - | プロフィール写真（未設定時は頭文字） |
| 一言自己紹介 | - | 短いbio文 |
| 所属チーム | - | チーム名 |
| SNSリンク | - | 最大5件（ラベル＋URL） |
| プロフィールページリンク | ○ | 詳細プロフィールページへのリンクボタン |
| カード番号 | ○ | 会員番号の表示 |

対応SNSプラットフォーム（アイコン表示）:
- X（旧Twitter）
- Instagram
- Facebook
- YouTube
- ホームページ（その他URL）

#### 3.1.3 詳細プロフィールページ

URL: `metalid.jp/u/{会員番号}/profile`

| 項目 | 公開設定 | 説明 |
|------|----------|------|
| モルックネーム | 常時公開 | - |
| アイコン画像 | 常時公開 | - |
| 所属チーム | 公開/非公開 | チーム名・地域 |
| モルック歴 | 公開/非公開 | いつからやっているか（年・月） |
| 活動地域 | 公開/非公開 | 都道府県レベル |
| 自己紹介（詳細） | 公開/非公開 | 長文bio |
| 出場大会一覧 | 公開/非公開 | 大会名・日付・順位 |
| 通算成績 | 公開/非公開 | 出場数・勝率等 |
| 取得バッジ | 常時公開 | 実績バッジ |

#### 3.1.4 管理者ダッシュボード

URL: `metalid.jp/admin`

| 機能 | 詳細 |
|------|------|
| 会員一覧 | 全会員の一覧・検索・フィルタ |
| 会員作成 | 新規会員番号の発行・招待URL生成 |
| 会員編集 | 会員情報の手動編集 |
| 招待URL管理 | 発行済みトークンの管理・再発行 |
| カード種別設定 | profile / redirect の切り替え |

#### 3.1.5 リダイレクト機能（現行維持）

- `type: redirect` の会員はプロフィールページではなく指定URLへ転送
- 既存の動作を維持

---

### Phase 2 — プロフィール強化

#### 3.2.1 戦績・大会記録

| 機能 | 詳細 |
|------|------|
| 大会記録の登録 | 大会名・日付・場所・順位・スコアを会員が自己申告入力 |
| 大会記録の閲覧 | 詳細プロフィールページで公開 |
| 通算統計の自動計算 | 出場回数・最高順位・平均順位 |
| 大会マスタ | 管理者が大会を登録し、会員が選択して記録 |

#### 3.2.2 バッジシステム

コミュニティへの参加・実績を可視化するバッジ。

| バッジ名 | 取得条件 |
|----------|----------|
| モルック初段 | 初大会出場 |
| コレクター | カードを10枚集める |
| ビッグコレクター | カードを50枚集める |
| 常連プレイヤー | 大会5回出場 |
| 入賞経験者 | 大会3位以内入賞 |
| 優勝経験者 | 大会優勝 |
| アーリーアダプター | 会員番号100番以内 |

バッジ取得は自動判定（システムが条件を確認して付与）

#### 3.2.3 プロフィール画像アップロード

- 画像形式: JPG / PNG / WebP
- 最大ファイルサイズ: 5MB
- 表示サイズ: 正方形（自動クロップ）

---

### Phase 3 — コレクション・コミュニティ機能

#### 3.3.1 カードコレクション機能

**「集める」体験の核心**

- 他の会員のQRをスキャン → そのカードをコレクションに追加
- コレクション一覧ページ: `metalid.jp/my/collection`
- コレクター数（自分のカードを何人が持っているか）の表示
- 「〇〇さんのカードを入手した！」という通知（オプション）

| 項目 | 詳細 |
|------|------|
| コレクション追加 | QRスキャン or プロフィールページから「コレクトする」ボタン |
| コレクション閲覧 | 自分が集めたカード一覧（顔写真・名前・カード番号） |
| コレクター数 | 自分のカードを何人が持っているか |
| 初コレクト | そのカードを初めてコレクトした記念表示 |

#### 3.3.2 大会マッチング（将来構想）

- 開催予定大会の一覧
- 出場登録・出場希望の登録
- 近い実力帯のプレイヤーとのマッチング提案
- 過去の対戦相手との再戦リクエスト

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 項目 | 目標値 |
|------|--------|
| ページ表示速度 | 初回表示 2秒以内（LCP） |
| QRスキャン→表示 | 3秒以内 |
| データ更新反映 | プロフィール編集後、即時反映 |

### 4.2 セキュリティ

| 項目 | 対策 |
|------|------|
| 認証 | JWTトークン or セッション管理 |
| 招待トークン | 使い捨て・有効期限あり |
| プロフィール編集 | 本人と管理者のみ |
| 個人情報 | 公開/非公開を会員自身が制御 |
| 管理画面 | 管理者アカウントのみアクセス可能 |

### 4.3 対応環境

| 項目 | 要件 |
|------|------|
| スマートフォン | iOS Safari / Android Chrome（メイン想定） |
| PC | Chrome / Firefox / Safari / Edge |
| QRスキャン | 標準カメラアプリ対応 |
| レスポンシブ | スマートフォンファーストのデザイン |

### 4.4 可用性・コスト

| 項目 | 要件 |
|------|------|
| 稼働率 | 99%以上（Vercelの無料プランで対応） |
| コスト目標 | 月額0〜500円程度（成長フェーズまで） |
| バックアップ | データベースの定期バックアップ |

---

## 5. データモデル設計

### 5.1 エンティティ関係図

```
Member ─────────── Profile
  │                  │
  │              Links (0〜5件)
  │
  ├── InviteToken
  │
  ├── TournamentRecord (Phase2)
  │
  ├── Badge (Phase2)
  │
  └── CardCollection (Phase3)
       ├── collector: Member
       └── collected: Member
```

### 5.2 主要テーブル設計

#### `members` テーブル（会員基本情報）

| カラム名 | 型 | 必須 | 説明 |
|----------|----|------|------|
| id | string | ○ | 会員番号（例: "000001"） |
| type | enum | ○ | "profile" or "redirect" |
| email | string | ○ | ログイン用メールアドレス |
| password_hash | string | ○ | パスワードのハッシュ |
| status | enum | ○ | "pending"（未登録）/ "active"（登録済み） |
| redirect_url | string | - | typeがredirectの場合の転送先URL |
| created_at | datetime | ○ | 作成日時 |
| last_login_at | datetime | - | 最終ログイン日時 |

#### `profiles` テーブル（プロフィール情報）

| カラム名 | 型 | 必須 | 説明 |
|----------|----|------|------|
| member_id | FK | ○ | 会員番号（membersへの外部キー） |
| molkky_name | string | ○ | モルックネーム（表示名） |
| avatar_url | string | - | プロフィール画像URL |
| bio_short | string | - | 一言自己紹介（ハブページ用、100文字以内） |
| bio_long | string | - | 詳細自己紹介（プロフィールページ用） |
| team_name | string | - | 所属チーム名 |
| region | string | - | 活動地域（都道府県） |
| career_start | date | - | モルック開始年月 |
| is_public | boolean | ○ | プロフィールの公開/非公開 |
| privacy_settings | JSON | - | 各フィールドの公開設定 |
| updated_at | datetime | ○ | 最終更新日時 |

#### `links` テーブル（SNSリンク）

| カラム名 | 型 | 必須 | 説明 |
|----------|----|------|------|
| id | int | ○ | 自動採番 |
| member_id | FK | ○ | 会員番号 |
| platform | enum | ○ | "x" / "instagram" / "facebook" / "youtube" / "website" / "other" |
| label | string | ○ | 表示ラベル（例: "X（個人）"） |
| url | string | ○ | リンク先URL |
| order | int | ○ | 表示順序（0〜4） |

#### `invite_tokens` テーブル（招待トークン）

| カラム名 | 型 | 必須 | 説明 |
|----------|----|------|------|
| token | string | ○ | ランダムな文字列トークン |
| member_id | FK | ○ | 対象会員番号 |
| expires_at | datetime | ○ | 有効期限（発行から30日） |
| used_at | datetime | - | 使用日時（nullなら未使用） |
| created_at | datetime | ○ | 発行日時 |

#### `tournament_records` テーブル（大会記録 - Phase2）

| カラム名 | 型 | 必須 | 説明 |
|----------|----|------|------|
| id | int | ○ | 自動採番 |
| member_id | FK | ○ | 会員番号 |
| tournament_name | string | ○ | 大会名 |
| tournament_date | date | ○ | 開催日 |
| location | string | - | 開催場所 |
| participants_count | int | - | 参加者数 |
| rank | int | - | 順位 |
| is_public | boolean | ○ | 公開/非公開 |
| note | string | - | メモ・コメント |

#### `card_collections` テーブル（コレクション - Phase3）

| カラム名 | 型 | 必須 | 説明 |
|----------|----|------|------|
| collector_id | FK | ○ | コレクトした人の会員番号 |
| collected_id | FK | ○ | コレクトされた人の会員番号 |
| collected_at | datetime | ○ | コレクトした日時 |
| is_first | boolean | ○ | 最初のコレクターかどうか |

---

## 6. URL設計

### 6.1 公開ページ（認証不要）

| URL | 説明 |
|-----|------|
| `/` | トップページ（サービス紹介） |
| `/u/{id}` | 個人ハブページ |
| `/u/{id}/profile` | 詳細プロフィールページ |
| `/register?token={token}` | 会員登録ページ（招待トークン必須） |
| `/login` | ログインページ |

### 6.2 会員ページ（ログイン必須）

| URL | 説明 |
|-----|------|
| `/my` | マイページトップ |
| `/my/edit` | プロフィール編集 |
| `/my/links` | リンク管理 |
| `/my/records` | 大会記録管理（Phase2） |
| `/my/collection` | カードコレクション（Phase3） |

### 6.3 管理者ページ（管理者のみ）

| URL | 説明 |
|-----|------|
| `/admin` | 管理者ダッシュボード |
| `/admin/members` | 会員一覧 |
| `/admin/members/new` | 会員新規作成 |
| `/admin/members/{id}` | 会員詳細・編集 |
| `/admin/invite` | 招待URL管理 |
| `/admin/tournaments` | 大会マスタ管理（Phase2） |

---

## 7. 技術スタック選定

### 7.1 現行 → 提案後の変化

| 項目 | 現行 | Phase1以降 | 理由 |
|------|------|------------|------|
| フロントエンド | Next.js 14 | Next.js 14（継続） | 変更不要 |
| データ管理 | Googleスプレッドシート | **Supabase（PostgreSQL）** | 認証・DB・ストレージが一体。無料枠あり |
| 認証 | なし | **Supabase Auth** | Supabaseに含まれる |
| 画像ストレージ | なし | **Supabase Storage** | Supabaseに含まれる |
| ホスティング | Vercel | Vercel（継続） | 変更不要 |
| スタイリング | Tailwind CSS | Tailwind CSS（継続） | 変更不要 |

### 7.2 Supabaseを選ぶ理由

- PostgreSQL + 認証 + ストレージが**無料で一体提供**
- Next.jsとの親和性が高い
- 管理画面でデータをGUIで確認・編集できる（スプレッドシートの代替感覚）
- 無料枠: DB 500MB・ストレージ 1GB・認証ユーザー 無制限

### 7.3 追加パッケージ（予定）

| パッケージ | 用途 |
|------------|------|
| `@supabase/supabase-js` | Supabaseクライアント |
| `@supabase/auth-helpers-nextjs` | Next.js用認証ヘルパー |
| `zod` | フォームバリデーション（型安全） |
| `react-hook-form` | フォーム管理 |
| `qrcode` | QRコード生成（管理者画面用） |

---

## 8. 開発フェーズと優先順位

### Phase 1（MVP） — 優先度: 最高

- [ ] Supabaseプロジェクトのセットアップ
- [ ] データベーススキーマの作成（members, profiles, links, invite_tokens）
- [ ] 会員登録フロー（招待トークン → 登録ページ → メール認証）
- [ ] ログイン / ログアウト
- [ ] 個人ハブページのリニューアル（現行の `/u/{id}` を認証対応版に）
- [ ] プロフィール編集ページ（`/my/edit`）
- [ ] リンク管理ページ（`/my/links`）
- [ ] 管理者ダッシュボード（会員作成・招待URL発行）
- [ ] 詳細プロフィールページ（`/u/{id}/profile`）

### Phase 2 — 優先度: 高

- [ ] 大会記録の登録・表示
- [ ] バッジシステムの実装
- [ ] プロフィール画像アップロード
- [ ] 大会マスタ管理（管理者）

### Phase 3 — 優先度: 中

- [ ] カードコレクション機能
- [ ] コレクター数の表示
- [ ] 大会マッチング（構想・検討）

---

## 9. 未決事項・検討事項

| 項目 | 現状 | 検討内容 |
|------|------|----------|
| 大会記録の信頼性 | 自己申告 | 管理者承認制にするか？証跡写真の添付は？ |
| コレクション方法 | QRスキャン時に自動追加 | 明示的なボタン操作が必要か？ |
| メールサービス | 未定 | Supabaseのデフォルト / Resend / SendGrid |
| 多言語対応 | 日本語のみ | 将来的に英語対応するか？ |
| チーム機能 | 個人のみ | チームページも作るか？ |
| カード番号体系 | 6桁（000001〜） | 変更の必要があるか？ |

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| **モルッカー** | モルックをプレイする人 |
| **メタルカード** | QRコード入りの金属製IDカード |
| **ハブページ** | リットリンクのような、各種リンクをまとめたページ |
| **招待トークン** | 会員登録に必要なワンタイムの暗号化文字列 |
| **Supabase** | PostgreSQL + 認証 + ストレージを提供するBaaSサービス |
| **BaaS** | Backend as a Service。バックエンドをサービスとして提供するもの |
| **外部キー（FK）** | 別のテーブルのレコードを参照するためのカラム |
| **JWT** | JSON Web Token。ログイン状態を安全にやり取りする仕組み |
| **レスポンシブ** | 画面サイズに応じてレイアウトが変わるデザイン |
| **LCP** | Largest Contentful Paint。ページの体感速度の指標 |
| **QRコード** | スキャンするとURLなどに飛べる二次元バーコード |
