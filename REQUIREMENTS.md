# METALID システム 要件定義書

**バージョン**: 2.0
**作成日**: 2026-02-18
**対象**: モルックコミュニティ向けメタルIDカードシステム

---

## 1. プロジェクト概要

### 1.1 ビジョン

> **「モルッカーがメタルカードを集めたくなる」**

メタルカードはただのIDではなく、コミュニティの繋がりを可視化する **コレクションアイテム**。
カードを持つこと・集めること自体が体験になる。

### 1.2 システム全体像

```
[メタルカード]  QRスキャン
     ↓
 個人ハブページ（/u/000001）
  ・モルックネーム・所属チーム
  ・一言bio・SNSリンク
  ・「詳細プロフィール」ボタン
  ・「コレクトする」ボタン（ログイン会員のみ）
     ↓
 詳細プロフィールページ（/u/000001/profile）
  ・大会出場歴・試合記録
  ・通算成績
  ・取得バッジ
```

### 1.3 カード配布フロー

```
【管理者】
  1. ダッシュボードで会員番号を発行
  2. 招待URL（トークン付き）を生成
  3. 招待URLのQRを紙に印刷 ← メタルカードとセットで渡す

【会員】
  1. 紙のQRをスキャン → 登録ページへ
  2. メールアドレス＋パスワードを設定
  3. メール認証 → 登録完了
  4. プロフィールをカスタマイズ

【以降】
  メタルカードのQR → 自分のハブページに直結
```

---

## 2. 決定事項まとめ

| 項目 | 決定内容 |
|------|----------|
| 認証方式 | メールアドレス＋パスワード（メール認証あり） |
| 招待方式 | 管理者発行の招待トークン経由のみ（オープン登録なし） |
| 対戦相手の記録 | 自由テキスト入力（会員IDとの紐付けなし） |
| コレクション取得 | QRスキャン後、ログイン済みなら自動追加 |
| 未ログインのQRスキャン | プロフィールは閲覧できる。コレクトはログイン促す |
| 試合記録フォーマット | 自由入力（ラウンド名も自由記述） |
| 大会記録の信頼性 | 自己申告のみ（承認制なし） |
| チーム機能 | なし |
| 多言語対応 | 日本語のみ |

---

## 3. ユーザー種別と権限

| 種別 | 認証 | できること |
|------|------|-----------|
| **ビジター** | 不要 | ハブページ・プロフィールの閲覧 |
| **会員** | ログイン必須 | プロフィール編集・大会記録・コレクション管理 |
| **管理者** | ログイン必須 | 会員管理・招待URL発行 |

---

## 4. 機能要件

### フェーズ構成

```
Phase 1 — 基盤    : 登録・ハブページ・管理者機能
Phase 2 — 記録    : 大会・試合記録フォーム
Phase 3 — 収集    : カードコレクション機能
Phase 4 — 実績    : バッジ・統計（将来）
```

---

### Phase 1 — 基盤（まず動かす）

#### 4.1.1 会員登録・認証

| 機能 | 詳細 |
|------|------|
| 会員登録 | 招待トークン付きURLからのみ登録可能 |
| メール認証 | 登録後、確認メールをクリックしてアクティベート |
| ログイン | メールアドレス＋パスワード |
| パスワードリセット | メール経由でリセット |
| 招待トークン | 使い捨て・30日で失効 |

#### 4.1.2 個人ハブページ

**URL**: `/u/{会員番号}` — 認証不要で閲覧可能

| 項目 | 必須 | 備考 |
|------|------|------|
| モルックネーム | ○ | 表示名 |
| アイコン画像 | - | 未設定時は頭文字のイニシャルアイコン |
| 一言自己紹介 | - | 100文字以内 |
| 所属チーム | - | |
| SNSリンク | - | 最大5件（プラットフォーム選択＋URL） |
| 詳細プロフィールへのリンク | ○ | フェーズ2以降で中身が充実 |
| 会員番号 | ○ | 表示 |
| コレクトボタン | - | ログイン会員のみ表示（Phase3） |

対応SNSプラットフォーム:
`X` / `Instagram` / `Facebook` / `YouTube` / `ホームページ（その他）`

#### 4.1.3 プロフィール編集（会員のみ）

**URL**: `/my/edit`

ハブページに表示する全項目を編集できる。
変更は即時反映。

#### 4.1.4 管理者ダッシュボード

**URL**: `/admin`

| 機能 | 詳細 |
|------|------|
| 会員一覧 | 一覧・検索・ステータス確認 |
| 会員作成 | 会員番号を発行し、招待URLを生成 |
| 招待URL表示 | QRコードとして表示・印刷用 |
| 招待URL再発行 | 期限切れ・紛失時の再発行 |
| カード種別変更 | `profile` ↔ `redirect` の切り替え |

#### 4.1.5 リダイレクト機能（現行維持）

`type: redirect` の会員はプロフィール表示せず、設定URLへ転送。

---

### Phase 2 — 大会・試合記録

#### 4.2.1 大会記録の登録

**URL**: `/my/records/new`

会員が自己申告でデータを入力する。

**大会情報（1大会につき1件）**

| 項目 | 必須 | 備考 |
|------|------|------|
| 大会名 | ○ | 自由入力 |
| 開催日 | ○ | 日付 |
| 開催場所 | - | 自由入力 |
| 参加人数 | - | 数値 |
| 最終順位 | - | 数値 |
| 大会メモ | - | 全体の振り返りなど自由記述 |
| 公開/非公開 | ○ | デフォルト: 公開 |

**試合記録（1大会につき複数件）**

大会の中の各試合を個別に記録する。

| 項目 | 必須 | 備考 |
|------|------|------|
| ラウンド名 | ○ | 自由入力（例:「予選第1試合」「決勝2回戦」） |
| 対戦相手 | - | 自由テキスト（名前を直接入力） |
| 結果 | ○ | 勝ち / 負け / 引き分け |
| 自分のスコア | - | 数値 |
| 相手のスコア | - | 数値 |
| 試合メモ | - | 自由記述（気づき・反省など） |

**入力イメージ:**
```
大会名: 川西モルック選手権2026
開催日: 2026-03-15  場所: 川西市民グラウンド
参加人数: 24人  最終順位: 5位

--- 試合記録 ---
[+試合を追加]

ラウンド: 予選第1試合
相手: 田中さん  結果: 勝ち  自分:50 相手:42
メモ: スキットルの並びがよかった

ラウンド: 予選第2試合
相手: サノさん  結果: 負け  自分:38 相手:50
メモ: 距離感がズレた、要練習

ラウンド: 決勝1回戦
相手: 山田さん  結果: 勝ち  自分:50 相手:47
メモ: 接戦だったが粘れた
```

#### 4.2.2 詳細プロフィールページ

**URL**: `/u/{会員番号}/profile` — 認証不要で閲覧可能

| セクション | 内容 | 公開設定 |
|------------|------|----------|
| 基本情報 | モルックネーム・チーム・地域・モルック歴 | 各項目で設定 |
| 自己紹介（詳細） | 長文bio | あり |
| 出場大会一覧 | 大会名・日付・場所・最終順位 | 大会単位で設定 |
| 試合記録 | 各大会の試合ごとの記録 | 大会の公開設定に連動 |
| 通算成績 | 出場回数・最高順位（大会記録から自動集計） | あり |

#### 4.2.3 大会記録の管理

**URL**: `/my/records`

- 登録した大会一覧
- 各大会の編集・削除
- 試合記録の追加・編集・削除

---

### Phase 3 — カードコレクション

#### 4.3.1 コレクション追加

- 他の会員のQRをスキャン → ハブページ表示
- ログイン済み会員には「コレクトする」ボタンが表示
- ボタンを押す or 自動追加でコレクションに登録
- 未ログインの場合: プロフィールは見れる。「コレクトするにはログインを」と表示

> **自動追加 vs ボタン操作の方針**: スキャン直後は「コレクトする」ボタンを1タップ。
> 誤登録防止のため完全自動は見送り。体験としては "1タップ" で十分。

#### 4.3.2 コレクション一覧

**URL**: `/my/collection`

- 自分が集めたカードの一覧（グリッド表示）
- 各カード: アイコン・モルックネーム・会員番号・コレクト日
- 集めた枚数の表示

#### 4.3.3 コレクター数の表示

- ハブページ・詳細プロフィールに「〇人がコレクト」を表示
- 本人には誰がコレクトしたかの一覧表示（オプション）

---

### Phase 4 — バッジ・実績（将来）

自動付与バッジ（条件達成で自動判定）:

| バッジ | 条件 |
|--------|------|
| アーリーアダプター | 会員番号100番以内 |
| モルック初段 | 大会に1回出場（記録済み） |
| 常連プレイヤー | 大会5回出場 |
| 入賞経験者 | 大会3位以内の記録あり |
| 優勝経験者 | 大会1位の記録あり |
| コレクター | カード10枚収集 |
| ビッグコレクター | カード50枚収集 |

バッジはハブページ・詳細プロフィールに表示。

---

## 5. 画面・URL設計

### 5.1 公開（認証不要）

| URL | 画面 |
|-----|------|
| `/` | トップ（サービス紹介） |
| `/u/{id}` | 個人ハブページ |
| `/u/{id}/profile` | 詳細プロフィールページ |
| `/register?token={token}` | 会員登録（招待トークン必須） |
| `/login` | ログイン |

### 5.2 会員（ログイン必須）

| URL | 画面 |
|-----|------|
| `/my` | マイページトップ |
| `/my/edit` | プロフィール編集 |
| `/my/records` | 大会記録一覧 |
| `/my/records/new` | 大会記録の新規登録 |
| `/my/records/{id}/edit` | 大会記録の編集 |
| `/my/collection` | コレクション一覧（Phase3） |

### 5.3 管理者（管理者のみ）

| URL | 画面 |
|-----|------|
| `/admin` | ダッシュボード |
| `/admin/members` | 会員一覧 |
| `/admin/members/new` | 会員作成・招待URL発行 |
| `/admin/members/{id}` | 会員詳細・編集 |

---

## 6. データモデル設計

### 6.1 エンティティ関係

```
members
  ├── profiles          (1:1)
  ├── links             (1:多, 最大5件)
  ├── invite_tokens     (1:多)
  ├── tournaments       (1:多) ← Phase2
  │     └── matches     (1:多)
  └── card_collections  (多:多) ← Phase3
        ├── collector側
        └── collected側
```

### 6.2 テーブル定義

#### `members`（会員基本情報）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| id | varchar(6) | ○ | 会員番号（例: "000001"） |
| email | varchar | ○ | ログイン用メールアドレス |
| type | enum | ○ | "profile" / "redirect" |
| status | enum | ○ | "pending" / "active" |
| redirect_url | varchar | - | type=redirect時の転送先 |
| is_admin | boolean | ○ | 管理者フラグ（default: false） |
| created_at | timestamp | ○ | |
| last_login_at | timestamp | - | |

※ パスワードハッシュはSupabase Authが管理するため、このテーブルには持たない。

#### `profiles`（プロフィール情報）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| member_id | FK | ○ | membersへの参照 |
| molkky_name | varchar(50) | ○ | モルックネーム |
| avatar_url | varchar | - | プロフィール画像URL |
| bio_short | varchar(100) | - | 一言自己紹介（ハブページ用） |
| bio_long | text | - | 詳細自己紹介（プロフィールページ用） |
| team_name | varchar(100) | - | 所属チーム名 |
| region | varchar(20) | - | 活動地域（都道府県） |
| career_start | date | - | モルック開始年月 |
| privacy_settings | jsonb | - | 各フィールドの公開/非公開設定 |
| updated_at | timestamp | ○ | |

**privacy_settings のJSON構造例:**
```json
{
  "team_name": true,
  "region": true,
  "career_start": false,
  "bio_long": true,
  "tournaments": true,
  "stats": true
}
```

#### `links`（SNSリンク）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| id | uuid | ○ | |
| member_id | FK | ○ | |
| platform | enum | ○ | "x" / "instagram" / "facebook" / "youtube" / "website" |
| label | varchar(50) | ○ | 表示ラベル |
| url | varchar | ○ | リンク先URL |
| display_order | int | ○ | 表示順（0〜4） |

#### `invite_tokens`（招待トークン）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| token | varchar | ○ | ランダムな文字列（UUID等） |
| member_id | FK | ○ | 対象会員 |
| expires_at | timestamp | ○ | 有効期限（発行から30日） |
| used_at | timestamp | - | 使用日時（nullなら未使用） |
| created_at | timestamp | ○ | |

#### `tournaments`（大会記録 — Phase2）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| id | uuid | ○ | |
| member_id | FK | ○ | |
| name | varchar(200) | ○ | 大会名 |
| held_on | date | ○ | 開催日 |
| location | varchar(200) | - | 開催場所 |
| participants_count | int | - | 参加人数 |
| final_rank | int | - | 最終順位 |
| note | text | - | 大会全体のメモ |
| is_public | boolean | ○ | 公開/非公開（default: true） |
| created_at | timestamp | ○ | |

#### `matches`（試合記録 — Phase2）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| id | uuid | ○ | |
| tournament_id | FK | ○ | 所属する大会 |
| round_name | varchar(100) | ○ | ラウンド名（自由入力）例:「予選第1試合」 |
| opponent_name | varchar(100) | - | 対戦相手名（自由入力） |
| result | enum | ○ | "win" / "loss" / "draw" |
| my_score | int | - | 自分のスコア |
| opponent_score | int | - | 相手のスコア |
| note | text | - | 試合メモ |
| display_order | int | ○ | 試合の順番 |

#### `card_collections`（コレクション — Phase3）

| カラム | 型 | 必須 | 説明 |
|--------|----|------|------|
| collector_id | FK | ○ | コレクトした人 |
| collected_id | FK | ○ | コレクトされた人 |
| collected_at | timestamp | ○ | コレクト日時 |
| is_first | boolean | ○ | 最初のコレクターかどうか |

---

## 7. 技術スタック

### 7.1 採用技術

| 領域 | 現行 | 採用 | 理由 |
|------|------|------|------|
| フロントエンド | Next.js 14 | Next.js 14（継続） | 変更不要 |
| データベース | Googleスプレッドシート | **Supabase（PostgreSQL）** | 認証・DB・ストレージが無料で一体 |
| 認証 | なし | **Supabase Auth** | 上記に含まれる |
| 画像ストレージ | なし | **Supabase Storage** | 上記に含まれる |
| メール送信 | なし | **Supabase（内蔵SMTP）** | 認証メール・リセットはSupabaseが標準提供 |
| ホスティング | Vercel | Vercel（継続） | 変更不要 |
| スタイリング | Tailwind CSS | Tailwind CSS（継続） | 変更不要 |

### 7.2 追加パッケージ

| パッケージ | 用途 |
|------------|------|
| `@supabase/supabase-js` | Supabaseクライアント |
| `@supabase/ssr` | Next.js App Router対応の認証ヘルパー |
| `zod` | フォームのバリデーション（型安全） |
| `react-hook-form` | フォーム状態管理 |
| `qrcode.react` | 管理者画面でのQRコード表示・印刷 |

### 7.3 コスト見通し

| 項目 | 費用 |
|------|------|
| ドメイン（metalid.jp） | 約1,500円/年 |
| Supabase（無料枠） | 無料（DB 500MB、ストレージ 1GB） |
| Vercel（無料枠） | 無料 |
| **合計** | **約1,500円/年** |

---

## 8. 開発ロードマップ

### Phase 1 — 基盤（最優先）

- [ ] Supabaseプロジェクト作成・環境変数設定
- [ ] DBスキーマ作成（members / profiles / links / invite_tokens）
- [ ] Supabase Auth設定（メール認証・パスワードリセット）
- [ ] 会員登録フロー（招待トークン検証 → 登録フォーム → メール認証）
- [ ] ログイン / ログアウト
- [ ] 個人ハブページのリニューアル（`/u/{id}`）
- [ ] プロフィール編集ページ（`/my/edit`）
- [ ] 管理者ダッシュボード（会員作成・招待URL発行・QR表示）
- [ ] Googleスプレッドシートからのデータ移行スクリプト

### Phase 2 — 大会・試合記録

- [ ] DBスキーマ追加（tournaments / matches）
- [ ] 大会記録の新規登録フォーム（大会情報＋試合記録の動的追加）
- [ ] 大会記録の編集・削除
- [ ] 詳細プロフィールページ（`/u/{id}/profile`）
- [ ] 通算成績の自動集計表示
- [ ] プロフィール画像アップロード（Supabase Storage）

### Phase 3 — コレクション

- [ ] DBスキーマ追加（card_collections）
- [ ] ハブページに「コレクトする」ボタン追加
- [ ] コレクション一覧ページ（`/my/collection`）
- [ ] コレクター数の表示

### Phase 4 — バッジ・実績（将来）

- [ ] バッジ判定ロジック
- [ ] バッジ表示UI

---

## 9. 未決事項

| 項目 | 状況 |
|------|------|
| プロフィール画像の保存先 | Supabase Storage使用予定。実装時に詳細決定 |
| コレクト時の通知 | 「〇〇さんがコレクトしました」通知は将来検討 |
| 大会マッチング | Phase4以降で要件定義 |
| カード番号の桁数 | 現行6桁（000001〜）のまま継続 |

---

## 10. 用語集

| 用語 | 説明 |
|------|------|
| **モルッカー** | モルックをプレイする人 |
| **メタルカード** | QRコード入りの金属製IDカード |
| **ハブページ** | リットリンクのような、各種リンクをまとめたページ（`/u/{id}`） |
| **招待トークン** | 会員登録に必要なワンタイムの暗号化文字列 |
| **Supabase** | PostgreSQL + 認証 + ストレージを提供するBaaSサービス |
| **BaaS** | Backend as a Service。バックエンドの基盤をサービスとして提供するもの |
| **外部キー（FK）** | 別テーブルのレコードを参照するカラム。テーブル間を紐付ける |
| **JWT** | JSON Web Token。ログイン状態を安全にやり取りする仕組み |
| **レスポンシブ** | 画面サイズに応じてレイアウトが変わるデザイン |
| **enum** | あらかじめ決まった値の中から選ぶ型（例: "win"/"loss"/"draw"） |
| **jsonb** | PostgreSQLのJSON型。柔軟なデータ構造を保存できる |
